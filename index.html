<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIMO SHOP | Custom Audio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --neon-blue: #00d2ff; --neon-pink: #bc13fe; --glass: rgba(255, 255, 255, 0.05); --card-border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; background: #050508; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; background-size: cover; background-position: center; background-attachment: fixed; transition: background 0.5s ease; padding-bottom: 80px; }
        .bg-neon { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 15% 15%, rgba(0, 210, 255, 0.15) 0%, transparent 45%), radial-gradient(circle at 85% 85%, rgba(188, 19, 254, 0.15) 0%, transparent 45%); z-index: -1; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050508; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .wallet-card { background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), rgba(188, 19, 254, 0.1)); border: 1px solid var(--neon-blue); border-radius: 25px; padding: 20px; margin-bottom: 30px; backdrop-filter: blur(15px); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .balance-amount { font-size: 26px; font-weight: 900; color: var(--neon-blue); }
        .topup-btn { background: var(--neon-blue); color: black; border: none; padding: 12px 20px; border-radius: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px var(--neon-blue); }
        .drawer-btn { position: fixed; right: 20px; top: 25px; z-index: 1000; background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); width: 45px; height: 45px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(10px); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); }
        .drawer-btn span { width: 25px; height: 3px; background: var(--neon-blue); border-radius: 2px; transition: 0.3s; }
        .drawer { position: fixed; top: 0; right: -310px; width: 290px; height: 100%; background: linear-gradient(165deg, rgba(10, 10, 15, 0.95) 0%, rgba(20, 10, 30, 0.98) 100%); backdrop-filter: blur(25px); z-index: 2000; transition: 0.5s; border-left: 2px solid rgba(0, 210, 255, 0.2); padding: 40px 25px; box-sizing: border-box; display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: none; z-index: 1500; }
        .drawer-item { background: rgba(255, 255, 255, 0.03); padding: 16px; border-radius: 18px; margin-bottom: 18px; border: 1px solid rgba(255, 255, 255, 0.08); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 15px; }
        #loader { position: fixed; width: 100%; height: 100vh; background: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .page { display: none; padding: 20px; animation: fadeIn 0.6s ease-out; max-width: 800px; margin: auto; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        header { display: flex; align-items: center; justify-content: center; margin-bottom: 40px; padding-top: 20px; position: relative; }
        .back-btn { position: absolute; left: 0; top: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--card-border); color: white; padding: 8px 15px; border-radius: 12px; cursor: pointer; font-size: 12px; }
        .k-logo { width: 70px; height: 70px; border-radius: 20px; overflow: hidden; border: 2px solid var(--neon-blue); box-shadow: 0 0 20px rgba(0, 210, 255, 0.5); }
        .k-logo img { width: 100%; height: 100%; object-fit: cover; }
        .shop-title-container { display: flex; flex-direction: column; margin-left: 20px; }
        .shop-title { font-size: 28px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-style: italic; background: linear-gradient(to right, #fff, var(--neon-blue)); -webkit-background-clip: text; color: transparent; margin: 0; }
        .user-display-name { color: var(--neon-pink); font-size: 14px; font-weight: bold; margin-top: 2px; }
        .slider-wrapper { padding: 8px; border-radius: 30px; border: 2px solid; border-image: linear-gradient(to right, var(--neon-blue), var(--neon-pink)) 1; margin-bottom: 40px; background: rgba(0,0,0,0.5); }
        .slider-container { width: 100%; aspect-ratio: 16/9; border-radius: 22px; overflow: hidden; position: relative; }
        .slides { display: flex; width: 300%; height: 100%; transition: 0.8s cubic-bezier(0.65, 0, 0.35, 1); }
        .slide { width: 100%; height: 100%; background-size: cover; background-position: center; display: flex; align-items: flex-end; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .main-card { background: rgba(20, 20, 25, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px); transition: 0.3s; position: relative; overflow: hidden; height: 220px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .cat-icon-container { width: 100%; height: 140px; display: flex; justify-content: center; align-items: center; overflow: hidden; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%); }
        .cat-icon { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card-bottom { width: 100%; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.6)); z-index: 2; padding-bottom: 10px; }
        .main-card h3 { font-size: 16px; text-align: center; margin: 0 0 8px 0; color: #fff; text-shadow: 0 0 5px var(--neon-blue); }
        .buy-pill { width: 80%; background: linear-gradient(90deg, #00c6ff, #0072ff); border: none; color: white; padding: 8px; border-radius: 50px; font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 10px rgba(0, 198, 255, 0.5); }
        .price-item { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-left: 4px solid var(--neon-blue); }
        .admin-input { width: 100%; padding: 15px; margin-bottom: 12px; background: #000; border: 1px solid #444; color: white; border-radius: 15px; box-sizing: border-box; }
        .adm-sec { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 25px; border: 1px solid var(--card-border); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050508; z-index: 5000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .acc-card { background: #111; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 1px solid #333; }
        .acc-img { width: 100%; height: 200px; object-fit: cover; }
        .acc-body { padding: 15px; }
        .acc-price { color: var(--neon-pink); font-size: 20px; font-weight: bold; }
        .order-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #333; }
        .detail-img-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
        .detail-img-grid img { width: 100%; border-radius: 10px; border: 1px solid var(--neon-blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }
        .fire-badge { position: absolute; top: 0; right: 0; background: linear-gradient(45deg, #ff0000, #ff8800); color: white; padding: 5px 12px; border-bottom-left-radius: 15px; font-size: 10px; font-weight: 900; z-index: 10; animation: burn 0.8s infinite alternate; }
        @keyframes burn { 0% { box-shadow: 0 0 5px #ff4400; transform: scale(1); } 100% { box-shadow: 0 0 20px #ffaa00; transform: scale(1.05); } }
        .price-edit-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .price-edit-row input { flex: 1; padding: 10px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; }
        .del-btn { background: #ff4444; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; }
        .adm-tabs { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 25px; padding: 5px; scrollbar-width: none; }
        .adm-tab { background: #111; padding: 12px 20px; border-radius: 15px; cursor: pointer; white-space: nowrap; border: 1px solid #333; color: #888; }
        .adm-tab.active { background: var(--neon-blue); color: black; font-weight: bold; }
        .pay-option { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .pay-option.selected { border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.1); }
        .radio-c { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #555; }
        .pay-option.selected .radio-c { background: var(--neon-blue); border-color: var(--neon-blue); }
        .detail-box { display: none; padding: 10px; background: #111; border-radius: 10px; margin-bottom: 15px; font-size: 13px; color: #aaa; }
    </style>
</head>
<body>
    <div class="bg-neon"></div>
    <div id="loader"><h1 style="color:var(--neon-blue); font-style:italic;">KIMO EVOLUTION...</h1></div>

    <audio id="bg-music-player" loop></audio>
    <audio id="sfx-player"></audio>

    <div id="login-screen">
        <div class="k-logo" style="margin-bottom: 20px;"><img src="" id="login-logo"></div>
        <h2 style="color: var(--neon-blue); margin-bottom: 20px; letter-spacing: 2px;">WELCOME TO KIMO SHOP</h2>
        <div class="adm-sec" style="width: 100%; max-width: 350px;">
            <input type="text" id="user-input" class="admin-input" placeholder="Enter Username">
            <button class="buy-pill" style="width: 100%; padding: 15px;" onclick="handleLogin()">ENTER SHOP</button>
        </div>
    </div>

    <button class="drawer-btn" onclick="toggleDrawer()"><span></span><span></span><span></span></button>
    <div class="drawer-overlay" id="d-overlay" onclick="toggleDrawer()"></div>
    <div class="drawer" id="d-menu">
        <h2 style="color:var(--neon-blue); border-bottom: 1px solid rgba(0,210,255,0.3); padding-bottom: 10px;">MENU</h2>
        <div class="drawer-item" onclick="nav('history-page')"><b>Order History</b></div>
        <div class="drawer-item" onclick="window.open('https://t.me/Ironman2005born')"><b>Contact Developer</b></div>
        <div class="drawer-item" onclick="drawerLogin()"><b>Admin Panel</b></div>
        <div class="drawer-item" onclick="location.reload()" style="border-color: var(--neon-pink);"><b>Logout</b></div>
    </div>

    <div id="main-page" class="page">
        <header>
            <div class="k-logo" onclick="logoClick()"><img id="display-logo" src=""></div>
            <div class="shop-title-container">
                <div class="shop-title">KIMO SHOP</div>
                <div id="display-username" class="user-display-name">User: Guest</div>
            </div>
        </header>
        
        <div class="slider-wrapper"><div class="slider-container"><div class="slides" id="slide-track">
            <div id="slide0" class="slide"></div>
            <div id="slide1" class="slide"></div>
            <div id="slide2" class="slide"></div>
        </div></div></div>

        <div class="wallet-card">
            <div><div style="font-size:11px; opacity:0.7;">MY BALANCE</div><div class="balance-amount"><span id="user-balance">0</span> MMK</div></div>
            <button class="topup-btn" onclick="document.getElementById('topup-modal').style.display='block'; playSfx('click')">+ TOP UP</button>
        </div>

        <div class="grid-layout">
            <div class="main-card" id="card-mlbb" onclick="nav('mlbb-page')"></div>
            <div class="main-card" id="card-pubg" onclick="nav('pubg-page')"></div>
            <div class="main-card" id="card-heartopia" onclick="nav('heartopia-page')"></div>
            <div class="main-card" id="card-tg" onclick="nav('tg-page')"></div>
        </div>
        <div class="main-card" onclick="nav('acc-page')" style="flex-direction:row; height: 100px; justify-content:space-between; align-items:center; margin-bottom:40px; padding: 0 20px; cursor: pointer;">
            <h3 style="margin:0; text-align:left;">ACCOUNT<br>MARKET</h3>
            <button class="buy-pill" style="width: auto; padding: 10px 20px; margin:0">VIEW STOCK</button>
        </div>
    </div>

    <div id="acc-details-modal" class="modal">
        <header><button class="back-btn" onclick="document.getElementById('acc-details-modal').style.display='none'; playSfx('click')"> CLOSE</button><div class="shop-title" style="font-size:18px;">DETAILS</div></header>
        <div class="adm-sec">
            <h2 id="det-title" style="color:var(--neon-blue); margin-top:0;">Account Title</h2>
            <div id="det-imgs" class="detail-img-grid"></div>
            <p id="det-desc" style="margin: 20px 0; line-height:1.6; color:#ccc; white-space: pre-wrap;"></p>
            <h2 id="det-price" style="color:var(--neon-pink); font-size: 24px;">0 MMK</h2>
            <button class="buy-pill" style="width:100%; height:50px; margin-top:20px; font-size: 16px;" id="det-buy-btn">BUY NOW</button>
        </div>
    </div>

    <div id="purchase-modal" class="modal">
        <h2 style="color:var(--neon-blue);">CONFIRM ORDER</h2>
        <div class="adm-sec">
            <h3 id="p-item-name">Item Name</h3>
            <h1 id="p-item-price" style="color:var(--neon-pink);">0 MMK</h1>
            <hr style="opacity:0.2; margin: 15px 0;">
            <p>Player ID / Server ID:</p>
            <input type="text" id="p-player-id" class="admin-input" placeholder="Example: 123456 (1234)">
            <p>Payment Method:</p>
            <div class="pay-option selected" id="opt-wallet" onclick="selectPay('wallet')">
                <div class="radio-c"></div>
                <div><b>KIMO Wallet</b> <br><span style="font-size:11px; opacity:0.7">Balance: <span id="modal-balance">0</span> MMK</span></div>
            </div>
            <div class="pay-option" id="opt-direct" onclick="selectPay('direct')">
                <div class="radio-c"></div>
                <div><b>Direct Transfer</b> <br><span style="font-size:11px; opacity:0.7">Kpay / Wave / KBZ</span></div>
            </div>
            <div id="info-direct" class="detail-box">
                <p><b>Kpay:</b> <span id="display-kpay">09...</span> (<span id="display-kpay-name">Name</span>)</p>
                <p><b>Wave:</b> <span id="display-wave">09...</span> (<span id="display-wave-name">Name</span>)</p>
                <p>Screenshot:</p>
                <input type="file" id="p-proof-img" class="admin-input" accept="image/*">
            </div>
            <button class="buy-pill" style="width:100%; margin-top:10px; height:45px;" onclick="submitOrder()">CONFIRM PURCHASE</button>
            <button class="buy-pill" style="width:100%; background:#222; margin-top:10px;" onclick="closeBuyModal()">CANCEL</button>
        </div>
    </div>

    <div id="admin-page" class="page">
        <header><button class="back-btn" onclick="nav('main-page')"> EXIT</button><div class="shop-title">ADMIN</div></header>
        <div class="adm-tabs">
            <div class="adm-tab active" onclick="switchAdm(this,'requests')">Requests</div>
            <div class="adm-tab" onclick="switchAdm(this,'orders')">Orders</div>
            <div class="adm-tab" onclick="switchAdm(this,'prices')">Prices</div>
            <div class="adm-tab" onclick="switchAdm(this,'acc')">Accounts</div>
            <div class="adm-tab" onclick="switchAdm(this,'visuals')">Settings</div>
            <div class="adm-tab" onclick="switchAdm(this,'audio')">Audio (New)</div>
        </div>
        
        <div id="adm-requests" class="adm-sec"><h4>Pending Topups</h4><div id="req-list"></div></div>
        <div id="adm-orders" class="adm-sec" style="display:none"><h4>Pending Orders</h4><div id="admin-order-list"></div></div>
        <div id="adm-prices" class="adm-sec" style="display:none">
            <div class="adm-tabs" style="margin-bottom:15px;">
                <div class="adm-tab" onclick="currCat='mlbb';renderPriceEdit()">MLBB</div>
                <div class="adm-tab" onclick="currCat='pubg';renderPriceEdit()">PUBG</div>
                <div class="adm-tab" onclick="currCat='heartopia';renderPriceEdit()">HEART</div>
                <div class="adm-tab" onclick="currCat='tg';renderPriceEdit()">TG</div>
            </div>
            <h4 id="edit-title">Editing</h4><div id="price-edit-area"></div>
            <button class="buy-pill" style="width:100%; margin-bottom: 10px; background: #333;" onclick="addItem()">+ Add Row</button>
            <button class="buy-pill" style="width:100%;" onclick="savePrices()">SAVE</button>
        </div>
        <div id="adm-acc" class="adm-sec" style="display:none">
            <h4>Post New Account</h4>
            <input type="text" id="a-title" class="admin-input" placeholder="Account Name/Title">
            <textarea id="a-desc" class="admin-input" placeholder="Account Details" style="height:80px;"></textarea>
            <input type="number" id="a-price" class="admin-input" placeholder="Price (MMK)">
            <input type="file" id="a-imgs" class="admin-input" multiple accept="image/*">
            <button class="buy-pill" style="width:100%" onclick="postAcc()">POST STOCK</button>
            <div id="admin-acc-list" style="margin-top:20px;"></div>
        </div>
        <div id="adm-visuals" class="adm-sec" style="display:none">
            <input type="text" id="adm-kp-num" class="admin-input" placeholder="Kpay No">
            <input type="text" id="adm-kp-name" class="admin-input" placeholder="Kpay Name">
            <input type="text" id="adm-wv-num" class="admin-input" placeholder="Wave No">
            <input type="text" id="adm-wv-name" class="admin-input" placeholder="Wave Name">
            <p>Logo: <input type="file" id="adm-logo" class="admin-input"></p>
            <p>Background: <input type="file" id="adm-bg" class="admin-input"></p>
            <p>Slider 1: <input type="file" id="adm-s0" class="admin-input"></p>
            <p>Slider 2: <input type="file" id="adm-s1" class="admin-input"></p>
            <p>Slider 3: <input type="file" id="adm-s2" class="admin-input"></p>
            <h4>Icons</h4>
            <p>MLBB: <input type="file" id="adm-icon-mlbb" class="admin-input"></p>
            <p>PUBG: <input type="file" id="adm-icon-pubg" class="admin-input"></p>
            <p>Heart: <input type="file" id="adm-icon-heartopia" class="admin-input"></p>
            <p>TG: <input type="file" id="adm-icon-tg" class="admin-input"></p>
            <button class="buy-pill" style="width:100%" onclick="saveVisuals()">SAVE SETTINGS</button>
        </div>

        <div id="adm-audio" class="adm-sec" style="display:none">
            <h4>Custom Music & Sounds</h4>
            <p style="font-size:12px; color:var(--neon-blue);">Upload MP3/WAV files from your phone.</p>
            <p>Background Music (BGM): <input type="file" id="adm-bgm-file" class="admin-input" accept="audio/*"></p>
            <p>Click Sound (SFX): <input type="file" id="adm-click-file" class="admin-input" accept="audio/*"></p>
            <p>Success Sound (SFX): <input type="file" id="adm-success-file" class="admin-input" accept="audio/*"></p>
            <p>Error/Alert Sound (SFX): <input type="file" id="adm-error-file" class="admin-input" accept="audio/*"></p>
            <p>Transition/Slide (SFX): <input type="file" id="adm-swoosh-file" class="admin-input" accept="audio/*"></p>
            <button class="buy-pill" style="width:100%" onclick="saveAudioSettings()">SAVE AUDIO</button>
        </div>
    </div>

    <div id="history-page" class="page"><header><button class="back-btn" onclick="nav('main-page')"> BACK</button><div class="shop-title">HISTORY</div></header><div id="user-order-history"></div></div>
    <div id="topup-modal" class="modal">
        <h2 style="color:var(--neon-blue);">TOP UP</h2>
        <div class="adm-sec">
            <p><b>Kpay:</b> <span id="top-kpay">...</span></p>
            <p><b>Wave:</b> <span id="top-wave">...</span></p>
            <input type="number" id="topup-amt" class="admin-input" placeholder="Amount">
            <input type="file" id="topup-file" class="admin-input" accept="image/*">
            <button class="buy-pill" style="width:100%" id="topup-submit-btn" onclick="submitTopup()">SUBMIT</button>
            <button class="buy-pill" style="width:100%; background:#222; margin-top:10px;" onclick="document.getElementById('topup-modal').style.display='none'; playSfx('click')">CANCEL</button>
        </div>
    </div>

    <div id="mlbb-page" class="page"><header><button class="back-btn" onclick="nav('main-page')"> BACK</button><div class="shop-title">MLBB</div></header><div id="list-mlbb"></div></div>
    <div id="pubg-page" class="page"><header><button class="back-btn" onclick="nav('main-page')"> BACK</button><div class="shop-title">PUBG</div></header><div id="list-pubg"></div></div>
    <div id="heartopia-page" class="page"><header><button class="back-btn" onclick="nav('main-page')"> BACK</button><div class="shop-title">HEARTOPIA</div></header><div id="list-heartopia"></div></div>
    <div id="tg-page" class="page"><header><button class="back-btn" onclick="nav('main-page')"> BACK</button><div class="shop-title">TELEGRAM</div></header><div id="list-tg"></div></div>
    <div id="acc-page" class="page"><header><button class="back-btn" onclick="nav('main-page')"> BACK</button><div class="shop-title">ACCOUNTS</div></header><div id="list-acc"></div></div>

    <script>
        const SUPABASE_URL = 'https://wfvcurswhruefkgtrvcl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmdmN1cnN3aHJ1ZWZrZ3RydmNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODg3NzQsImV4cCI6MjA4NjU2NDc3NH0.eOR7yiXZi4VK5VtdmN8sh-wZ1loVLVh3EHm7LlRHS5c';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = ""; 
        let db = { mlbb: [], pubg: [], heartopia: [], tg: [], accs: [], requests: [], orders: [], balance: 0 };
        let settings = { popular: '', kpayNum: '', kpayName: '', waveNum: '', waveName: '', s0:'', s1:'', s2:'', logo:'', bg:'', icon_mlbb:'', icon_pubg:'', icon_heartopia:'', icon_tg:'' }; 
        let audioSettings = { bgm: '', click: '', success: '', error: '', swoosh: '' };
        let currentOrder = { name: '', price: 0 };
        let selectedPayment = 'wallet';
        let logoTapCount = 0; let currCat = 'mlbb';

        // --- AUDIO SYSTEM (ENHANCED) ---
        function playSfx(type) {
            const player = document.getElementById('sfx-player');
            if (audioSettings[type]) {
                player.src = audioSettings[type];
                player.volume = 0.6;
                player.play().catch(e => console.log("SFX Error"));
            }
        }

        function startBGM() {
            const bgm = document.getElementById('bg-music-player');
            if (audioSettings.bgm) {
                bgm.src = audioSettings.bgm;
                bgm.volume = 0.3;
                bgm.play().catch(e => console.log("BGM needs interaction"));
            }
        }

        async function saveAudioSettings() {
            const loaders = {
                bgm: 'adm-bgm-file', click: 'adm-click-file', success: 'adm-success-file', 
                error: 'adm-error-file', swoosh: 'adm-swoosh-file'
            };
            for (let key in loaders) {
                const fileInput = document.getElementById(loaders[key]);
                if (fileInput.files[0]) {
                    audioSettings[key] = await procImg(fileInput.files[0]); // Conver to Base64
                }
            }
            await _supabase.from('kimo_store').upsert({ category: 'site_audio', content: audioSettings }, { onConflict: 'category' });
            alert("Audio Settings Saved!");
        }

        // --- CORE FUNCTIONS ---
        function handleLogin() {
            const user = document.getElementById('user-input').value.trim();
            if(user !== "") {
                currentUser = user;
                document.getElementById('display-username').innerText = "User: " + user;
                document.getElementById('login-screen').style.display = 'none';
                startBGM(); 
                playSfx('success');
                fetchCloudDB(); 
                nav('main-page');
            } else { alert("Please enter a username"); }
        }

        async function fetchCloudDB() {
            const { data } = await _supabase.from('kimo_store').select('*');
            if (data) {
                data.forEach(row => {
                    if (row.category === 'wallet_requests') db.requests = row.content || [];
                    else if (row.category === 'site_settings') settings = { ...settings, ...row.content };
                    else if (row.category === 'site_audio') audioSettings = { ...audioSettings, ...row.content };
                    else if (row.category === 'site_orders') db.orders = row.content || [];
                    else if (row.category === 'site_accs') db.accs = row.content || [];
                    else if (row.category === 'wallet_' + currentUser) db.balance = row.content?.balance || 0;
                    else if (db[row.category] !== undefined) db[row.category] = row.content || [];
                });
            }
            renderMain();
            renderAccs();
        }

        function renderMain() {
            document.getElementById('user-balance').innerText = (db.balance || 0).toLocaleString();
            if(settings.logo) { document.querySelectorAll('#display-logo, #login-logo').forEach(el=>el.src=settings.logo); }
            if(settings.bg) document.body.style.backgroundImage = `url(${settings.bg})`;
            
            document.getElementById('display-kpay').innerText = settings.kpayNum || '...';
            document.getElementById('top-kpay').innerText = `${settings.kpayNum || '...'} (${settings.kpayName || '...'})`;
            document.getElementById('top-wave').innerText = `${settings.waveNum || '...'} (${settings.waveName || '...'})`;

            for(let i=0; i<3; i++) {
                const sEl = document.getElementById('slide'+i);
                if(sEl && settings['s'+i]) sEl.style.backgroundImage = `url(${settings['s'+i]})`;
            }

            ['mlbb', 'heartopia', 'pubg', 'tg'].forEach(c => {
                const card = document.getElementById('card-' + c);
                if(card) {
                    const iconUrl = settings['icon_' + c] || '';
                    card.innerHTML = `
                        ${settings.popular === c ? '<div class="fire-badge"> HOT</div>' : ''}
                        <div class="cat-icon-container">${iconUrl ? `<img src="${iconUrl}" class="cat-icon">` : `<h2>${c.toUpperCase()}</h2>`}</div>
                        <div class="card-bottom"><h3>${c.toUpperCase()}</h3><button class="buy-pill">BUY NOW</button></div>
                    `;
                }
                const list = document.getElementById('list-'+c);
                if(list) list.innerHTML = (db[c] || []).map(i => `<div class="price-item"><span>${i[0]}</span><button class="buy-pill" style="width:auto; padding: 10px 15px;" onclick="openBuyModal('${i[0]}', ${i[1]})">${(i[1] || 0).toLocaleString()} MMK</button></div>`).join('');
            });

            const userOrders = db.orders.filter(o => o.username === currentUser);
            document.getElementById('user-order-history').innerHTML = userOrders.map(o => `
                <div class="order-card" style="border-right: 4px solid ${o.status==='Completed'?'#00ff00':(o.status==='Rejected'?'#ff4444':'yellow')}">
                    <p><b>${o.item}</b> - ${(o.price || 0).toLocaleString()} MMK</p>
                    <span style="color:${o.status==='Completed'?'#00ff00':(o.status==='Rejected'?'#ff4444':'yellow')}">${o.status}</span>
                </div>
            `).join('') || '<p style="text-align:center; opacity:0.5">No Orders</p>';

            renderAdminOrders();
            renderAdminRequests();
        }

        async function submitOrder() {
            const pid = document.getElementById('p-player-id').value;
            if(!pid) return alert("Enter Player ID");
            if(selectedPayment === 'wallet') {
                if(db.balance < currentOrder.price) { playSfx('error'); return alert("လက်ကျန်ငွေ မလုံလောက်ပါ"); }
                db.balance -= currentOrder.price;
            }
            db.orders.unshift({ id: Date.now(), username: currentUser, item: currentOrder.name, price: currentOrder.price, playerId: pid, status: 'Pending', date: new Date().toLocaleString() });
            await Promise.all([
                _supabase.from('kimo_store').upsert({ category: 'site_orders', content: db.orders }, { onConflict: 'category' }),
                _supabase.from('kimo_store').upsert({ category: 'wallet_' + currentUser, content: { balance: db.balance } }, { onConflict: 'category' })
            ]);
            playSfx('success'); alert("Order Success!"); closeBuyModal(); renderMain();
        }

        async function submitTopup() {
            const amt = parseInt(document.getElementById('topup-amt').value);
            const fileInput = document.getElementById('topup-file');
            if(!amt || !fileInput.files[0]) { playSfx('error'); return alert("Fill data"); }
            const proof = await procImg(fileInput.files[0]);
            db.requests.unshift({ id: Date.now(), username: currentUser, amt, proof, status: 'Pending', date: new Date().toLocaleString() });
            await _supabase.from('kimo_store').upsert({ category: 'wallet_requests', content: db.requests }, { onConflict: 'category' });
            playSfx('success'); alert("Request Sent!"); document.getElementById('topup-modal').style.display = 'none'; renderMain();
        }

        async function approveRequest(i) {
            const req = db.requests[i];
            const { data } = await _supabase.from('kimo_store').select('content').eq('category', 'wallet_' + req.username).single();
            let newBal = (data ? (data.content.balance || 0) : 0) + req.amt;
            db.requests.splice(i, 1);
            await Promise.all([
                _supabase.from('kimo_store').upsert({ category: 'wallet_' + req.username, content: { balance: newBal } }, { onConflict: 'category' }), 
                _supabase.from('kimo_store').upsert({ category: 'wallet_requests', content: db.requests }, { onConflict: 'category' })
            ]);
            playSfx('success'); alert("Approved!"); renderMain();
        }

        function nav(id) { 
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active-page')); 
            document.getElementById(id).classList.add('active-page'); 
            if(document.getElementById('d-menu').classList.contains('open')) toggleDrawer(); 
            playSfx('swoosh'); window.scrollTo(0,0); 
        }
        
        function toggleDrawer() { 
            document.getElementById('d-menu').classList.toggle('open'); 
            document.getElementById('d-overlay').style.display = document.getElementById('d-menu').classList.contains('open') ? 'block' : 'none'; 
            playSfx('click');
        }

        function openBuyModal(name, price) { 
            currentOrder = { name, price }; 
            document.getElementById('p-item-name').innerText = name; 
            document.getElementById('p-item-price').innerText = price.toLocaleString() + ' MMK'; 
            document.getElementById('modal-balance').innerText = (db.balance || 0).toLocaleString(); 
            document.getElementById('purchase-modal').style.display = 'block'; 
            playSfx('click'); selectPay('wallet'); 
        }
        function closeBuyModal() { document.getElementById('purchase-modal').style.display = 'none'; playSfx('click'); }
        function selectPay(m) { selectedPayment = m; document.getElementById('opt-wallet').classList.toggle('selected', m==='wallet'); document.getElementById('opt-direct').classList.toggle('selected', m==='direct'); document.getElementById('info-direct').style.display = m === 'direct' ? 'block' : 'none'; playSfx('click'); }
        const procImg = f => new Promise(res => { const r = new FileReader(); r.readAsDataURL(f); r.onload = e => res(e.target.result); });
        function switchAdm(el, id) { document.querySelectorAll('.adm-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); ['requests', 'orders', 'prices', 'acc', 'visuals', 'audio'].forEach(s=>document.getElementById('adm-'+s).style.display='none'); document.getElementById('adm-'+id).style.display='block'; if(id==='prices') renderPriceEdit(); }
        function renderPriceEdit() { const container = document.getElementById('price-edit-area'); container.innerHTML = ''; (db[currCat] || []).forEach((item, index) => { container.innerHTML += `<div class="price-edit-row"><input type="text" value="${item[0]}" id="p-name-${index}"><input type="number" value="${item[1]}" id="p-price-${index}"><button class="del-btn" onclick="db['${currCat}'].splice(${index},1);renderPriceEdit()">X</button></div>`; }); }
        function addItem() { db[currCat].push(["New Item", 0]); renderPriceEdit(); }
        async function savePrices() { const rows = document.querySelectorAll('.price-edit-row'); let newData = []; rows.forEach((row, i) => { newData.push([document.getElementById(`p-name-${i}`).value, parseInt(document.getElementById(`p-price-${i}`).value)]); }); db[currCat] = newData; await _supabase.from('kimo_store').upsert({ category: currCat, content: newData }, { onConflict: 'category' }); alert("Saved!"); renderMain(); }
        async function saveVisuals() { settings.kpayNum = document.getElementById('adm-kp-num').value; settings.kpayName = document.getElementById('adm-kp-name').value; settings.waveNum = document.getElementById('adm-wv-num').value; settings.waveName = document.getElementById('adm-wv-name').value; const fileIds = { bg:'adm-bg', logo:'adm-logo', s0:'adm-s0', s1:'adm-s1', s2:'adm-s2', icon_mlbb:'adm-icon-mlbb', icon_pubg:'adm-icon-pubg', icon_heartopia:'adm-icon-heartopia', icon_tg:'adm-icon-tg' }; for (let key in fileIds) { const input = document.getElementById(fileIds[key]); if(input && input.files[0]) settings[key] = await procImg(input.files[0]); } await _supabase.from('kimo_store').upsert({ category: 'site_settings', content: settings }, { onConflict: 'category' }); alert("Visual Settings saved!"); renderMain(); }
        function drawerLogin() { if(prompt("Pass:")==="kimo1500") nav('admin-page'); }
        function logoClick() { logoTapCount++; if(logoTapCount == 5) drawerLogin(); setTimeout(() => logoTapCount = 0, 2000); }
        function startSlider() { let i=0; setInterval(()=>{ i=(i+1)%3; if(document.getElementById('slide-track')) document.getElementById('slide-track').style.transform=`translateX(-${i*33.333}%)`; }, 5000); }
        window.onload = () => { setTimeout(() => { document.getElementById('loader').style.display='none'; startSlider(); }, 1200); };

        function renderAdminRequests() { const reqList = document.getElementById('req-list'); if(reqList) reqList.innerHTML = db.requests.map((r, i) => `<div class="order-card"><p><b>${r.username}</b> - ${r.amt.toLocaleString()} MMK</p><button onclick="window.open('${r.proof}')">View Proof</button><br><button onclick="approveRequest(${i})" style="background:var(--neon-blue); color:black; border:none; padding:8px; border-radius:8px; font-weight:bold; margin-top:5px;">Approve</button></div>`).join(''); }
        function renderAdminOrders() { const list = document.getElementById('admin-order-list'); if(list) { list.innerHTML = db.orders.filter(o => o.status === 'Pending').map((o, i) => `<div class="order-card"><p><b>User: ${o.username}</b><br>${o.item} (${o.playerId})</p><button onclick="updateOrder(${o.id},'Completed')" style="background:var(--neon-blue); color:black; border:none; padding:8px; border-radius:8px; font-weight:bold;">Done</button></div>`).join(''); } }
        async function updateOrder(id, s) { const idx = db.orders.findIndex(o => o.id === id); if(idx !== -1) { db.orders[idx].status = s; await _supabase.from('kimo_store').upsert({ category: 'site_orders', content: db.orders }, { onConflict: 'category' }); renderMain(); } }
        function renderAccs() { const list = document.getElementById('list-acc'); if(!list) return; list.innerHTML = db.accs.filter(a => !a.sold).map(a => `<div class="acc-card"><div class="acc-body"><h3>${a.title}</h3><div class="acc-price">${a.price.toLocaleString()} MMK</div><button class="buy-pill" style="width:100%; margin-top:10px;" onclick="openBuyModal('${a.title}', ${a.price})">BUY ACCOUNT</button></div></div>`).join(''); }
    </script>
</body>
</html>
